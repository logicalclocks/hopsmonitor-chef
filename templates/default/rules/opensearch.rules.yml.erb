groups:
- name: opensearch 
  rules:
  - alert: YellowCluster 
    expr: max(elasticsearch_cluster_health_status{color="yellow"}) by (cluster) > 0 
    for: 5m
    labels:
      type: system-alert
    annotations:
      summary: "Opensearch cluster state is yellow"
      description: "Opensearch cluster health is degraded."

  - alert: RedCluster 
    expr: max(elasticsearch_cluster_health_status{color="red"}) by (cluster) > 0 
    for: 5m
    labels:
      type: system-alert
    annotations:
      summary: "Opensearch cluster state is red"
      description: "Opensearch cluster is down."

  - alert: NoMetrics 
    expr: absent(elasticsearch_cluster_health_status) 
    for: 5m
    labels:
      type: system-alert
    annotations:
      summary: "No metrics are reported for Opensearch"
      description: "Opensearch cluster is not reporting any metric."
  
  - alert: TooManyShards
    expr: max(elasticsearch_cluster_health_active_shards) > 0.9 * max(elasticsearch_cluster_health_number_of_data_nodes) * max(elasticsearch_clustersettings_stats_max_shards_per_node)	
    for: 5m
    labels:
      type: system-alert
    annotations:
      summary: "Openseach cluster is running out of shards"
      description: "Opensearch cluster is reaching the maximum number of shards."

  - alert: Opensearch_Heap_Memory_Usage_High
    expr: avg_over_time(elasticsearch_jvm_memory_used_bytes{area="heap"}[15m]) / elasticsearch_jvm_memory_max_bytes{area="heap"} > 0.8
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: "High Heap Memory Usage in Opensearch"
      description: "Heap memory usage is above 80% in Opensearch instance {{ $labels.instance }} of cluster {{ $labels.cluster }} for the last 15 minutes."
